# 定时任务配置指南 - 图文详解

## 🎯 目标

配置两个定时任务，实现自动发布：
- **早报**：每天 7:00 自动发布
- **晚报**：每天 15:30 自动发布

---

## 📋 方式1：使用批处理脚本（最简单）⭐推荐

### 步骤1：找到配置脚本

文件位置：
```
E:\jieyue_data\Market-Intelligence-Publisher\配置定时任务.bat
```

### 步骤2：以管理员身份运行

**重要：必须使用管理员权限！**

1. 找到文件 `配置定时任务.bat`
2. **右键点击**
3. 选择 **"以管理员身份运行"**
4. 如果弹出UAC提示，点击"是"

### 步骤3：等待配置完成

脚本会自动：
- ✅ 删除旧任务（如果存在）
- ✅ 创建早报任务（7:00执行）
- ✅ 创建晚报任务（15:30执行）
- ✅ 显示配置结果

### 步骤4：验证任务

按 `Win + R`，输入 `taskschd.msc`，回车
在任务计划程序中查看：
- 金融行情早报发布
- 金融行情晚报发布

---

## 📋 方式2：使用任务计划程序（图形界面）

### 步骤1：打开任务计划程序

1. 按 `Win + R`
2. 输入 `taskschd.msc`
3. 回车

### 步骤2：创建早报任务

#### 2.1 创建基本任务
1. 点击右侧 **"创建基本任务"**
2. 名称：`金融行情早报发布`
3. 描述：`每天早上7:00自动发布金融行情早报`
4. 点击 **下一步**

#### 2.2 设置触发器
1. 选择 **"每天"**
2. 点击 **下一步**
3. 开始时间：选择 **07:00:00**
4. 每隔：**1** 天
5. 点击 **下一步**

#### 2.3 设置操作
1. 选择 **"启动程序"**
2. 点击 **下一步**
3. 程序或脚本：
   ```
   D:\Program Files\Python310\python.exe
   ```
4. 添加参数：
   ```
   E:\jieyue_data\Market-Intelligence-Publisher\morning_report_publisher.py
   ```
5. 起始于：
   ```
   E:\jieyue_data\Market-Intelligence-Publisher
   ```
6. 点击 **下一步**

#### 2.4 完成设置
1. 勾选 **"当单击'完成'时，打开此任务属性的对话框"**
2. 点击 **完成**

#### 2.5 高级设置
在打开的属性对话框中：
1. 切换到 **"常规"** 选项卡
2. 勾选 **"使用最高权限运行"**
3. 勾选 **"如果过了计划开始时间，立即启动任务"**
4. 点击 **确定**

### 步骤3：创建晚报任务

重复步骤2，但修改以下内容：
- 名称：`金融行情晚报发布`
- 描述：`每天下午15:30自动发布金融行情晚报`
- 开始时间：**15:30:00**
- 添加参数：
  ```
  E:\jieyue_data\Market-Intelligence-Publisher\market_report_publisher.py
  ```

---

## 📋 方式3：使用命令行（高级用户）

### 打开管理员命令提示符

1. 按 `Win + X`
2. 选择 **"Windows PowerShell (管理员)"** 或 **"命令提示符 (管理员)"**

### 创建早报任务

```cmd
schtasks /create /tn "金融行情早报发布" ^
  /tr "\"D:\Program Files\Python310\python.exe\" \"E:\jieyue_data\Market-Intelligence-Publisher\morning_report_publisher.py\"" ^
  /sc daily /st 07:00 /rl highest /f
```

### 创建晚报任务

```cmd
schtasks /create /tn "金融行情晚报发布" ^
  /tr "\"D:\Program Files\Python310\python.exe\" \"E:\jieyue_data\Market-Intelligence-Publisher\market_report_publisher.py\"" ^
  /sc daily /st 15:30 /rl highest /f
```

---

## ✅ 验证配置

### 方法1：查看任务列表

```cmd
schtasks /query /tn "金融行情早报发布"
schtasks /query /tn "金融行情晚报发布"
```

### 方法2：打开任务计划程序

1. 按 `Win + R`，输入 `taskschd.msc`
2. 在左侧找到 **"任务计划程序库"**
3. 查看任务列表，应该看到：
   - 金融行情早报发布
   - 金融行情晚报发布

### 方法3：立即测试运行

**测试早报：**
```cmd
schtasks /run /tn "金融行情早报发布"
```

**测试晚报：**
```cmd
schtasks /run /tn "金融行情晚报发布"
```

等待30秒左右，然后登录微信公众号后台查看草稿箱。

---

## 🔧 任务管理

### 查看任务状态

```cmd
schtasks /query /tn "金融行情早报发布" /v /fo list
```

### 启用任务

```cmd
schtasks /change /tn "金融行情早报发布" /enable
schtasks /change /tn "金融行情晚报发布" /enable
```

### 禁用任务

```cmd
schtasks /change /tn "金融行情早报发布" /disable
schtasks /change /tn "金融行情晚报发布" /disable
```

### 删除任务

```cmd
schtasks /delete /tn "金融行情早报发布" /f
schtasks /delete /tn "金融行情晚报发布" /f
```

### 修改执行时间

**修改早报时间为6:30：**
```cmd
schtasks /change /tn "金融行情早报发布" /st 06:30
```

**修改晚报时间为16:00：**
```cmd
schtasks /change /tn "金融行情晚报发布" /st 16:00
```

---

## 📊 执行计划

配置完成后的执行计划：

| 时间 | 任务 | 内容 |
|------|------|------|
| **每天 07:00** | 早报发布 | 隔夜美股、亚太市场、市场要闻 |
| **每天 15:30** | 晚报发布 | A股收盘、美股最新、商品期货 |

---

## 📝 注意事项

### 1. 管理员权限
- ⚠️ 创建定时任务必须使用管理员权限
- ⚠️ 任务运行时也需要有足够的权限

### 2. Python路径
- ✅ 确保Python路径正确：`D:\Program Files\Python310\python.exe`
- ✅ 如果Python安装在其他位置，需要修改路径

### 3. 工作目录
- ✅ 起始目录必须设置为：`E:\jieyue_data\Market-Intelligence-Publisher`
- ✅ 这样脚本才能找到 `config.json` 配置文件

### 4. 网络连接
- ✅ 确保定时执行时电脑联网
- ✅ 能够访问微信API和阿里云API

### 5. 电脑状态
- ⚠️ 电脑必须开机才能执行任务
- ⚠️ 如果电脑休眠，任务不会执行
- ✅ 建议设置：在属性中勾选"唤醒计算机运行此任务"

### 6. 节假日处理
- 📅 A股休市日可以临时禁用晚报
- 📅 使用命令：`schtasks /change /tn "金融行情晚报发布" /disable`
- 📅 节后重新启用：`schtasks /change /tn "金融行情晚报发布" /enable`

---

## 🔍 故障排查

### 问题1：任务未执行

**检查项：**
1. 任务计划程序中任务状态是否"已启用"
2. 查看"上次运行时间"和"上次运行结果"
3. 上次运行结果应该是 `0x0`（成功）

**解决方法：**
- 检查Python路径是否正确
- 检查工作目录是否正确
- 手动运行测试

### 问题2：执行报错

**检查项：**
1. 打开任务计划程序
2. 双击任务，查看"历史记录"选项卡
3. 查看错误信息

**解决方法：**
- 检查 `config.json` 是否存在且配置正确
- 手动运行Python脚本，查看错误信息
- 检查网络连接

### 问题3：草稿未生成

**检查项：**
1. 微信公众号凭证是否正确
2. access_token是否获取成功
3. 图片上传是否成功

**解决方法：**
- 检查 `config.json` 中的appid和secret
- 查看任务执行日志
- 手动运行脚本测试

---

## 📈 日志记录（可选）

如果需要记录执行日志，可以修改任务：

### 创建带日志的批处理文件

创建 `run_morning_with_log.bat`：
```batch
@echo off
set LOG_DIR=E:\jieyue_data\Market-Intelligence-Publisher\logs
set LOG_FILE=%LOG_DIR%\morning_%date:~0,4%%date:~5,2%%date:~8,2%.log

if not exist %LOG_DIR% mkdir %LOG_DIR%

echo ========================================== >> %LOG_FILE%
echo [%date% %time%] 开始执行早报发布 >> %LOG_FILE%
echo ========================================== >> %LOG_FILE%

cd /d "E:\jieyue_data\Market-Intelligence-Publisher"
"D:\Program Files\Python310\python.exe" morning_report_publisher.py >> %LOG_FILE% 2>&1

echo [%date% %time%] 执行完成 >> %LOG_FILE%
echo. >> %LOG_FILE%
```

然后修改定时任务，执行这个批处理文件而不是直接执行Python。

---

## 🎯 快速开始

### 推荐步骤（3步完成）：

1. **右键运行配置脚本**
   - 找到 `配置定时任务.bat`
   - 右键 → 以管理员身份运行

2. **测试任务**
   ```cmd
   schtasks /run /tn "金融行情早报发布"
   ```

3. **查看结果**
   - 登录微信公众号后台
   - 进入素材管理 → 草稿箱
   - 查看生成的简报

---

## ✅ 配置完成检查清单

- [ ] 任务计划程序中能看到两个任务
- [ ] 任务状态为"已启用"
- [ ] 任务属性中"使用最高权限运行"已勾选
- [ ] 手动运行测试成功
- [ ] 微信草稿箱能看到生成的内容
- [ ] Python路径正确
- [ ] 工作目录正确
- [ ] config.json配置正确

---

**配置完成后，系统将每天自动发布早报和晚报！** 🎉
