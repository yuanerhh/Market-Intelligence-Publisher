# 金融行情早报+晚报 定时任务配置指南

## 📅 定时任务规划

### 早报：每天 7:00
- **内容**：隔夜美股收盘、亚太市场、市场要闻
- **脚本**：`morning_report_publisher.py`

### 晚报：每天 15:30
- **内容**：A股收盘、美股最新、商品期货
- **脚本**：`market_report_publisher.py`

---

## 🖥️ Windows 定时任务设置

### 方法1：使用任务计划程序（推荐）

#### 设置早报任务（7:00）

1. **打开任务计划程序**
   - 按 `Win + R`
   - 输入 `taskschd.msc`
   - 回车

2. **创建早报任务**
   - 点击"创建基本任务"
   - 名称：`金融行情早报发布`
   - 描述：`每天早上7:00自动发布行情早报`

3. **设置触发器**
   - 选择"每天"
   - 开始时间：`07:00:00`
   - 每隔：1天

4. **设置操作**
   - 程序或脚本：`D:\Program Files\Python310\python.exe`
   - 添加参数：`E:\jieyue_data\morning_report_publisher.py`
   - 起始于：`E:\jieyue_data`

5. **高级设置**
   - 勾选"使用最高权限运行"
   - 勾选"如果过了计划开始时间，立即启动任务"

#### 设置晚报任务（15:30）

重复上述步骤，修改：
- 名称：`金融行情晚报发布`
- 开始时间：`15:30:00`
- 添加参数：`E:\jieyue_data\market_report_publisher.py`

---

### 方法2：使用PowerShell脚本一键创建

保存以下内容为 `create_scheduled_tasks.ps1`：

```powershell
# 创建早报任务（7:00）
$morningAction = New-ScheduledTaskAction `
    -Execute "D:\Program Files\Python310\python.exe" `
    -Argument "E:\jieyue_data\morning_report_publisher.py" `
    -WorkingDirectory "E:\jieyue_data"

$morningTrigger = New-ScheduledTaskTrigger -Daily -At 7:00AM

$morningPrincipal = New-ScheduledTaskPrincipal `
    -UserId "$env:USERNAME" `
    -RunLevel Highest

Register-ScheduledTask `
    -TaskName "金融行情早报发布" `
    -Action $morningAction `
    -Trigger $morningTrigger `
    -Principal $morningPrincipal `
    -Description "每天早上7:00自动发布金融行情早报"

Write-Host "✓ 早报任务创建成功！" -ForegroundColor Green

# 创建晚报任务（15:30）
$eveningAction = New-ScheduledTaskAction `
    -Execute "D:\Program Files\Python310\python.exe" `
    -Argument "E:\jieyue_data\market_report_publisher.py" `
    -WorkingDirectory "E:\jieyue_data"

$eveningTrigger = New-ScheduledTaskTrigger -Daily -At 3:30PM

$eveningPrincipal = New-ScheduledTaskPrincipal `
    -UserId "$env:USERNAME" `
    -RunLevel Highest

Register-ScheduledTask `
    -TaskName "金融行情晚报发布" `
    -Action $eveningAction `
    -Trigger $eveningTrigger `
    -Principal $eveningPrincipal `
    -Description "每天下午15:30自动发布金融行情晚报"

Write-Host "✓ 晚报任务创建成功！" -ForegroundColor Green
Write-Host "`n所有定时任务已创建完成！" -ForegroundColor Cyan
```

**执行方式：**
```powershell
# 以管理员身份运行PowerShell
powershell -ExecutionPolicy Bypass -File create_scheduled_tasks.ps1
```

---

### 方法3：使用schtasks命令

```cmd
REM 创建早报任务
schtasks /create /tn "金融行情早报发布" ^
  /tr "\"D:\Program Files\Python310\python.exe\" \"E:\jieyue_data\morning_report_publisher.py\"" ^
  /sc daily /st 07:00 /rl highest

REM 创建晚报任务
schtasks /create /tn "金融行情晚报发布" ^
  /tr "\"D:\Program Files\Python310\python.exe\" \"E:\jieyue_data\market_report_publisher.py\"" ^
  /sc daily /st 15:30 /rl highest
```

---

## 🐧 Linux/Mac 定时任务设置

### 使用Crontab

```bash
# 编辑crontab
crontab -e

# 添加以下两行
# 早报：每天7:00执行
0 7 * * * /usr/bin/python3 /path/to/morning_report_publisher.py >> /path/to/logs/morning.log 2>&1

# 晚报：每天15:30执行
30 15 * * * /usr/bin/python3 /path/to/market_report_publisher.py >> /path/to/logs/evening.log 2>&1
```

---

## 📊 任务管理命令

### Windows

**查看任务列表：**
```cmd
schtasks /query /tn "金融行情早报发布"
schtasks /query /tn "金融行情晚报发布"
```

**立即运行测试：**
```cmd
schtasks /run /tn "金融行情早报发布"
schtasks /run /tn "金融行情晚报发布"
```

**删除任务：**
```cmd
schtasks /delete /tn "金融行情早报发布" /f
schtasks /delete /tn "金融行情晚报发布" /f
```

**禁用任务：**
```cmd
schtasks /change /tn "金融行情早报发布" /disable
```

**启用任务：**
```cmd
schtasks /change /tn "金融行情早报发布" /enable
```

### Linux/Mac

**查看定时任务：**
```bash
crontab -l
```

**编辑定时任务：**
```bash
crontab -e
```

**删除所有定时任务：**
```bash
crontab -r
```

---

## 📝 日志记录配置

### Windows批处理日志版本

创建 `run_morning_report.bat`：
```batch
@echo off
set LOG_DIR=E:\jieyue_data\logs
set LOG_FILE=%LOG_DIR%\morning_%date:~0,4%%date:~5,2%%date:~8,2%.log

if not exist %LOG_DIR% mkdir %LOG_DIR%

echo ========================================== >> %LOG_FILE%
echo [%date% %time%] 开始执行早报发布 >> %LOG_FILE%
echo ========================================== >> %LOG_FILE%

"D:\Program Files\Python310\python.exe" "E:\jieyue_data\morning_report_publisher.py" >> %LOG_FILE% 2>&1

echo [%date% %time%] 执行完成 >> %LOG_FILE%
echo. >> %LOG_FILE%
```

创建 `run_evening_report.bat`：
```batch
@echo off
set LOG_DIR=E:\jieyue_data\logs
set LOG_FILE=%LOG_DIR%\evening_%date:~0,4%%date:~5,2%%date:~8,2%.log

if not exist %LOG_DIR% mkdir %LOG_DIR%

echo ========================================== >> %LOG_FILE%
echo [%date% %time%] 开始执行晚报发布 >> %LOG_FILE%
echo ========================================== >> %LOG_FILE%

"D:\Program Files\Python310\python.exe" "E:\jieyue_data\market_report_publisher.py" >> %LOG_FILE% 2>&1

echo [%date% %time%] 执行完成 >> %LOG_FILE%
echo. >> %LOG_FILE%
```

**修改定时任务，执行批处理文件而非直接执行Python：**
- 早报：`E:\jieyue_data\run_morning_report.bat`
- 晚报：`E:\jieyue_data\run_evening_report.bat`

---

## ⚠️ 注意事项

1. **Python路径** - 确保Python路径正确，使用 `where python` 查看
2. **工作目录** - 设置正确的工作目录，确保能找到config.json
3. **权限** - 使用"最高权限运行"避免权限问题
4. **时区** - 确认系统时间正确
5. **网络** - 确保定时执行时网络畅通
6. **测试** - 先手动测试脚本运行正常，再设置定时任务

---

## 🔍 故障排查

### 任务未执行

1. 检查任务计划程序中任务状态
2. 查看"上次运行结果"是否为成功（0x0）
3. 检查日志文件是否生成
4. 手动运行批处理文件测试

### 执行报错

1. 检查Python路径是否正确
2. 检查config.json是否存在且配置正确
3. 检查网络连接
4. 查看日志文件中的错误信息

### 微信API调用失败

1. 检查access_token是否过期
2. 检查API调用频率是否超限
3. 检查公众号权限是否足够

---

## 📈 监控建议

### 添加邮件通知

在Python脚本中添加邮件发送功能，执行失败时自动发送邮件通知：

```python
import smtplib
from email.mime.text import MIMEText

def send_error_email(error_msg):
    msg = MIMEText(f"行情简报发布失败：\n\n{error_msg}")
    msg['Subject'] = '行情简报发布失败通知'
    msg['From'] = 'your_email@example.com'
    msg['To'] = 'admin@example.com'
    
    smtp = smtplib.SMTP('smtp.example.com', 587)
    smtp.starttls()
    smtp.login('your_email@example.com', 'password')
    smtp.send_message(msg)
    smtp.quit()
```

### 定期检查

建议每周检查一次：
- 任务执行历史
- 日志文件
- 微信草稿箱

---

## 🎯 快速开始

1. **测试脚本**
   ```cmd
   python E:\jieyue_data\morning_report_publisher.py
   python E:\jieyue_data\market_report_publisher.py
   ```

2. **创建定时任务**
   - 使用PowerShell脚本一键创建
   - 或手动在任务计划程序中创建

3. **测试定时任务**
   ```cmd
   schtasks /run /tn "金融行情早报发布"
   schtasks /run /tn "金融行情晚报发布"
   ```

4. **查看结果**
   - 登录微信公众号后台查看草稿箱
   - 检查日志文件确认执行状态

完成！🎉
